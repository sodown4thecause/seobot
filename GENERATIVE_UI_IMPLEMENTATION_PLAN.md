# Generative UI & Conversation Persistence Implementation Plan

## âœ… Completed

### 1. Database Schema
- âœ… Created `conversations` table with agent_type, status (active/archived/deleted)
- âœ… Created `messages` table linked to conversations
- âœ… Created `library_items` table for saved responses/images/data
- âœ… Added RLS policies for all tables
- âœ… Added triggers for auto-updating conversation timestamps
- âœ… Migration file: `supabase/migrations/20250105000001_conversations_library_archive.sql`

### 2. Generative UI Components
- âœ… `KeywordMetrics` - Display keyword data in modern table with metrics
- âœ… `SerpResults` - Display SERP results with position badges and features
- âœ… `DomainAnalytics` - Display domain metrics in card grid
- âœ… `SaveToLibraryButton` - Button component to save items to library
- âœ… API endpoint: `/api/library/save` for saving library items

## ğŸš§ In Progress

### 3. Chat API Updates (CURRENT TASK)
Need to update `app/api/chat/route.ts` to:
- [ ] Accept `conversationId` and `agentId` in request body
- [ ] Create new conversation if none exists
- [ ] Load conversation history from database
- [ ] Save all messages to `messages` table
- [ ] Update conversation's `last_message_at` timestamp
- [ ] Return `conversationId` in response metadata

### 4. Chat Interface Updates
Need to update `components/chat/ai-chat-interface.tsx` to:
- [ ] Parse and render generative UI components from AI responses
- [ ] Detect special markers like `<KeywordMetrics>`, `<SerpResults>`, `<DomainAnalytics>`
- [ ] Render `SaveToLibraryButton` after each AI response
- [ ] Add Archive button in chat header
- [ ] Load conversation history on mount
- [ ] Pass `conversationId` to chat API

### 5. System Prompt Updates
Need to update agent prompts in `lib/agents/prompts.ts` to:
- [ ] Instruct AI to use generative UI components instead of markdown
- [ ] Remove instructions to use #'s and *'s for formatting
- [ ] Add instructions to wrap data in special XML tags for component rendering
- [ ] Example: `<KeywordMetrics data={...} />` instead of markdown tables

## ğŸ“‹ Remaining Tasks

### 6. Library Page (`/dashboard/library`)
- [ ] Create page component
- [ ] Fetch library items from database
- [ ] Display items in grid/list view
- [ ] Add filtering by item type (response/image/data)
- [ ] Add search functionality
- [ ] Add delete/export functionality

### 7. Archived Conversations Page (`/dashboard/archived`)
- [ ] Create page component
- [ ] Fetch archived conversations
- [ ] Display conversations with preview
- [ ] Add restore functionality
- [ ] Add permanent delete functionality
- [ ] Add search/filter by agent type

### 8. Sidebar Updates
- [ ] Update sidebar to show recent conversations
- [ ] Add "Archived" link (already exists in FEATURES array)
- [ ] Add "Library" link (already exists in FEATURES array)
- [ ] Show conversation count badges

## ğŸ¯ Implementation Order

1. **First**: Update chat API to support conversations âœ… (Database schema done)
2. **Second**: Update chat interface to render generative UI components
3. **Third**: Update system prompts to use generative UI
4. **Fourth**: Build Library page
5. **Fifth**: Build Archived page
6. **Sixth**: Update sidebar with conversation list

## ğŸ“ Key Design Decisions

### Generative UI Component Detection
The AI will wrap data in special XML-like tags:
```xml
<KeywordMetrics>
{
  "keywords": [
    {"keyword": "seo tools", "searchVolume": 12000, "cpc": 2.5, "competition": "high"}
  ]
}
</KeywordMetrics>
```

The chat interface will:
1. Parse these tags from AI responses
2. Extract the JSON data
3. Render the appropriate React component
4. Add a `SaveToLibraryButton` below each component

### No Markdown Formatting
- AI responses will NOT use `#` for headings
- AI responses will NOT use `*` or `**` for emphasis
- All data will be in clean text or generative UI components
- Tables will be rendered as React components, not markdown

### Conversation Persistence
- Every chat creates or continues a conversation
- Conversations are linked to specific agents
- Messages are saved in real-time
- Conversation title is auto-generated from first user message
- Users can archive entire conversations

### Library System
- Users can save individual AI responses
- Users can save images generated by AI
- Users can save structured data (keyword metrics, SERP data)
- Library items are tagged and searchable
- Library items can be exported (CSV/JSON)

## ğŸ”§ Technical Notes

### AI SDK 6 Integration
- Using `ToolLoopAgent` for automatic multi-step tool calling
- Using `createAgentUIStreamResponse` for streaming
- Metadata tracking includes tool usage and performance metrics

### Database Triggers
- `update_conversation_timestamp()` - Auto-updates `last_message_at` when message added
- `generate_conversation_title()` - Auto-generates title from first user message

### RLS Security
- All tables have RLS enabled
- Users can only access their own conversations, messages, and library items
- Policies enforce user_id matching on all operations

